version: "3.8"
networks:
  prime:
    driver: bridge
    attachable: true
  app-network:
    driver: bridge
    attachable: true

volumes:
  redis-data:

services:
  reth:
    image: ghcr.io/paradigmxyz/reth:latest
    platform: linux/amd64
    entrypoint: ["reth", "node", "--dev", "--chain", "dev", "--dev.block-time", "2sec", "--http", "--ws", "--http.addr", "0.0.0.0", "--ws.addr", "0.0.0.0", "--metrics", "0.0.0.0:9001"]
    ports:
      - "8545:8545"
      - "9001:9001"
    networks:
      - prime
      - app-network
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "timeout 5 bash -c 'echo > /dev/tcp/localhost/8545' || exit 1"]
      interval: 3s
      timeout: 5s
      retries: 3
      start_period: 10s

  contract-deployer:
    image: ghcr.io/foundry-rs/foundry:latest
    platform: linux/amd64
    volumes:
      - ./smart-contracts:/app
    working_dir: /app
    environment:
      - RPC_URL=http://reth:8545
    entrypoint: ["/bin/sh", "-c"]
    command: |
     "
     set -x
     echo 'Starting contract deployment...'
     chmod +x ./deploy.sh
     chmod +x ./deploy_work_validation.sh
     set +e
     ./deploy.sh && ./deploy_work_validation.sh
     set -e
     echo 'Deployment completed.'
     "
    networks:
      - prime
    depends_on:
      reth:
        condition: service_healthy

  redis:
    image: redis:alpine
    ports:
      - "6380:6379"
    networks:
      - prime
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  bootnode:
    image: ghcr.io/primeintellect-ai/protocol/bootnode:dev
    platform: linux/amd64
    ports:
      - "4005:4005"
    environment:
      - LIBP2P_PRIVATE_KEY="d0884c9823a0a2c846dbf5e71853bc5f80b2ec5d2de46532cdbe8ab46f020836"
    networks:
      - prime
    depends_on:
      reth:
        condition: service_healthy
      redis:
        condition: service_healthy
      contract-deployer:
        condition: service_completed_successfully

  orchestrator:
    image: ghcr.io/primeintellect-ai/protocol/orchestrator:dev
    platform: linux/amd64
    ports:
      - "8090:8090"
    environment:
      - RPC_URL=http://reth:8545
      - REDIS_STORE_URL=redis://redis:6379
      - URL=http://localhost:8090
      - COORDINATOR_KEY=${POOL_OWNER_PRIVATE_KEY}
      - COMPUTE_POOL_ID=${WORKER_COMPUTE_POOL_ID}
      - DOMAIN_ID=0
      - PORT=8090
      - DISCOVERY_REFRESH_INTERVAL=10
      - S3_CREDENTIALS=${S3_CREDENTIALS}
      - BOOTNODES="/ip4/127.0.0.1/tcp/4005/p2p/12D3KooWJj3haDEzxGSbGSAvXCiE9pDYC9xHDdtQe8B2donhfwXL"
    networks:
      - prime
    depends_on:
      reth:
        condition: service_healthy
      redis:
        condition: service_healthy
      bootnode:
        condition: service_started

  validator:
    image: ghcr.io/primeintellect-ai/protocol/validator:dev
    platform: linux/amd64
    ports:
      - "8099:8080"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - prime
    environment:
      - RPC_URL=http://reth:8545
      - VALIDATOR_KEY=${PRIVATE_KEY_VALIDATOR}
      - WORK_VALIDATION_CONTRACT=${WORK_VALIDATION_CONTRACT}
      - POOL_ID=${WORKER_COMPUTE_POOL_ID}
      - WORK_VALIDATION_INTERVAL=30
      - TOPLOC_SERVER_URL=${TOPLOC_SERVER_URL}
      - TOPLOC_AUTH_TOKEN=${TOPLOC_AUTH_TOKEN}
      - TOPLOC_GRACE_INTERVAL=15
      - REDIS_URL=redis://redis:6379
      - BOOTNODES="/ip4/127.0.0.1/tcp/4005/p2p/12D3KooWJj3haDEzxGSbGSAvXCiE9pDYC9xHDdtQe8B2donhfwXL"
    depends_on:
      reth:
        condition: service_healthy
      redis:
        condition: service_healthy
      bootnode:
        condition: service_started
